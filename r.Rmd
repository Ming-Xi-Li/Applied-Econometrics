---
title: "Homework2: RPractice"
author: "Ming-Xi Li"
date: "2024-12-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Homework2: RPractice

## Question 1 Please describe how you load the data into R. 
```{r}
# Load the package
library(readxl)

# Load the Excel data
data <- read_excel("C:/Users/terry/OneDrive/桌面/應用計量 term paper/pwt1001.xlsx", sheet = "Data")
```

## Question 2.1 Check if there are any missing values for any variables in the dataset. Describe your findings.
```{r}
# Get a summary to identify any NA values
summary(data)
```
## Question 2.2 Examine whether there are any exact duplicate observations, considering the values of all variables. Describe your findings. 
```{r}
# Use dplyr to remove duplicates and get distinct rows
library(dplyr)
```


```{r}
# Use distinct() to get unique rows
data_distinct <- distinct(data)

# Print the number of rows in the dataset after removing duplicates
print(nrow(data_distinct))
```


```{r}
# Get the number of rows in the original dataset
original_row_count <- nrow(data)

# Print the number of rows in the original dataset
print(original_row_count)
```

## Question 3 Briefly describe three R commands you used during the data cleaning process.
```{r}
# Filter data for the years 1970 to 1995
data_filtered <- data %>% filter(year >= 1970 & year <= 1995)
```

```{r}
# Calculate the GDP growth rate based on the rgdpo value in 1970
data_filtered <- data_filtered %>%
  group_by(country) %>% # Group data by each country
  mutate(
    rgdpo_base = rgdpo[year == 1970], # Create a new variable for the 1970 baseline value
    rgdpo_growth = rgdpo / rgdpo_base # Calculate the growth rate based on the 1970 value
  ) %>%
  ungroup() # Ungroup after operation
```

```{r}
# Calculate the exchange rate growth rate based on the xr value in 1970
data_filtered <- data_filtered %>%
  group_by(country) %>% # Group data by each country
  mutate(
    xr_base = xr[year == 1970], # Create a new variable for the 1970 baseline exchange rate
    xr_growth = xr / xr_base # Calculate the growth rate of exchange rate based on the 1970 value
  ) %>%
  ungroup() # Ungroup after operation
```

```{r}
# Create "export" and calculate "export_growth" based on 1970 value
data_filtered <- data_filtered %>%
  # Create the export variable
  mutate(export = csh_x * rgdpo) %>%
  # Group by country to ensure the growth rate is calculated independently for each country
  group_by(country) %>%
  # Create a new variable for the 1970 export value and calculate export growth
  mutate(
    export_base = export[year == 1970],  # Create the 1970 base export value
    export_growth = export / export_base # Calculate export growth based on the 1970 value
  ) %>%
  # Ungroup after calculation
  ungroup()
```

## Question 4-1 Create a graph that can represent one of the findings in your term paper. 
```{r}
# Load the necessary library
library(ggplot2)

# Filter data for Japan only
data_japan <- data_filtered %>% filter(country == "Japan")

# Plot rgdpo_growth from 1970 to 1995 for Japan
ggplot(data_japan, aes(x = year, y = rgdpo_growth)) +
  geom_line(color = "darkblue", size = 1.2) + # Make the line thicker
  labs(
    title = "Real GDP Growth Rate of Japan from 1970 to 1995",
    x = "Year",
    y = "Real GDP Growth Rate (Base Year: 1970)"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold") # Center-align and bold the title
  )

# Plot xr_growth from 1970 to 1995 for Japan
ggplot(data_japan, aes(x = year, y = xr_growth)) +
  geom_line(color = "darkred", size = 1.2) + # Make the line thicker
  labs(
    title = "Exchange Rate Growth Rate of Japan from 1970 to 1995",
    x = "Year",
    y = "Exchange Rate Growth Rate (Base Year: 1970)"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold") # Center-align and bold the title
  )

# Plot export_growth from 1970 to 1995 for Japan
ggplot(data_japan, aes(x = year, y = export_growth)) +
  geom_line(color = "darkgreen", size = 1.2) + # Make the line thicker
  labs(
    title = "Export Growth Rate of Japan from 1970 to 1995",
    x = "Year",
    y = "Export Growth Rate (Base Year: 1970)"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold") # Center-align and bold the title
  )


```

## Question 5.2 刪除有缺失值的國家
```{r}
# Load necessary libraries
library(dplyr)

# Filter the data for the full period (1970-1995)
full_period_data <- data_filtered %>%
  filter(year >= 1970 & year <= 1995)

# Remove countries with missing values in any growth rate variable during the full period
valid_countries <- full_period_data %>%
  group_by(country) %>%
  filter(
    !any(is.na(rgdpo_growth)) &
    !any(is.na(xr_growth)) &
    !any(is.na(export_growth))
  ) %>%
  distinct(country) %>%
  pull(country)

# Filter the original dataset to only include the valid countries
clean_data <- data_filtered %>%
  filter(country %in% valid_countries)

# Print the list of countries that remain after filtering
print(valid_countries)



```

## 計算清理過後的資料集每個國家的 MSE
```{r}
# Load necessary libraries
library(dplyr)
library(tibble)

# Filter the data for Japan during the pre-treatment period (1970-1985)
japan_data_pre <- clean_data %>%
  filter(country == "Japan", year >= 1970 & year <= 1985)

# Extract the Japanese growth rate values for the pre-treatment period
japan_rgdpo_growth <- japan_data_pre$rgdpo_growth
japan_xr_growth <- japan_data_pre$xr_growth
japan_export_growth <- japan_data_pre$export_growth

# List of valid countries excluding Japan and assign a unique ID to each country
valid_countries <- unique(clean_data$country)
valid_countries <- valid_countries[valid_countries != "Japan"]

# Create a tibble to store MSE results for each country
mse_results <- tibble(
  country_id = integer(),
  country_name = character(),
  mse_rgdpo_growth = double(),
  mse_xr_growth = double(),
  mse_export_growth = double()
)

# Loop through each valid country using the assigned ID and calculate MSE
for (i in 1:length(valid_countries)) {
  # Extract country name and corresponding ID
  country_name <- valid_countries[i]
  
  # Filter the data for the current country during the pre-treatment period (1970-1985)
  country_data_pre <- clean_data %>%
    filter(country == country_name, year >= 1970 & year <= 1985)
  
  # Extract the growth rate values for the current country
  country_rgdpo_growth <- country_data_pre$rgdpo_growth
  country_xr_growth <- country_data_pre$xr_growth
  country_export_growth <- country_data_pre$export_growth
  
  # Calculate MSE for Real GDP Growth Rate between Japan and the current country
  mse_rgdpo_growth <- mean((japan_rgdpo_growth - country_rgdpo_growth)^2, na.rm = TRUE)
  
  # Calculate MSE for Exchange Rate Growth between Japan and the current country
  mse_xr_growth <- mean((japan_xr_growth - country_xr_growth)^2, na.rm = TRUE)
  
  # Calculate MSE for Export Growth Rate between Japan and the current country
  mse_export_growth <- mean((japan_export_growth - country_export_growth)^2, na.rm = TRUE)
  
  # Add the MSE results for the current country to the tibble
  mse_results <- mse_results %>%
    add_row(
      country_id = i,
      country_name = country_name,
      mse_rgdpo_growth = mse_rgdpo_growth,
      mse_xr_growth = mse_xr_growth,
      mse_export_growth = mse_export_growth
    )
}

# Print the MSE results tibble
print(mse_results)

```

## 三個總經指標成長率只要有一個 MSE>1 就剔除 
```{r}
# Load necessary libraries
library(dplyr)
library(tibble)

# Filter the data for Japan during the pre-treatment period (1970-1985)
japan_data_pre <- clean_data %>%
  filter(country == "Japan", year >= 1970 & year <= 1985)

# Extract the Japanese growth rate values for the pre-treatment period
japan_rgdpo_growth <- japan_data_pre$rgdpo_growth
japan_xr_growth <- japan_data_pre$xr_growth
japan_export_growth <- japan_data_pre$export_growth

# List of valid countries excluding Japan and assign a unique ID to each country
valid_countries <- unique(clean_data$country)
valid_countries <- valid_countries[valid_countries != "Japan"]

# Create a tibble to store MSE results for each country
mse_results <- tibble(
  country_id = integer(),
  country_name = character(),
  mse_rgdpo_growth = double(),
  mse_xr_growth = double(),
  mse_export_growth = double()
)

# Loop through each valid country using the assigned ID and calculate MSE
for (i in 1:length(valid_countries)) {
  # Extract country name and corresponding ID
  country_name <- valid_countries[i]
  
  # Filter the data for the current country during the pre-treatment period (1970-1985)
  country_data_pre <- clean_data %>%
    filter(country == country_name, year >= 1970 & year <= 1985)
  
  # Extract the growth rate values for the current country
  country_rgdpo_growth <- country_data_pre$rgdpo_growth
  country_xr_growth <- country_data_pre$xr_growth
  country_export_growth <- country_data_pre$export_growth
  
  # Calculate MSE for Real GDP Growth Rate between Japan and the current country
  mse_rgdpo_growth <- mean((japan_rgdpo_growth - country_rgdpo_growth)^2, na.rm = TRUE)
  
  # Calculate MSE for Exchange Rate Growth between Japan and the current country
  mse_xr_growth <- mean((japan_xr_growth - country_xr_growth)^2, na.rm = TRUE)
  
  # Calculate MSE for Export Growth Rate between Japan and the current country
  mse_export_growth <- mean((japan_export_growth - country_export_growth)^2, na.rm = TRUE)
  
  # Only add the country to the tibble if all MSE values are <= 1
  if (mse_rgdpo_growth <= 1 && mse_xr_growth <= 1 && mse_export_growth <= 1) {
    mse_results <- mse_results %>%
      add_row(
        country_id = i,
        country_name = country_name,
        mse_rgdpo_growth = mse_rgdpo_growth,
        mse_xr_growth = mse_xr_growth,
        mse_export_growth = mse_export_growth
      )
  }
}

# Print the MSE results tibble
print(mse_results)

```

## 剔除與廣場協定相關的國家(美英法德)
```{r}
# Load necessary libraries
library(dplyr)
library(tibble)

# Filter the data for Japan during the pre-treatment period (1970-1985)
japan_data_pre <- clean_data %>%
  filter(country == "Japan", year >= 1970 & year <= 1985)

# Extract the Japanese growth rate values for the pre-treatment period
japan_rgdpo_growth <- japan_data_pre$rgdpo_growth
japan_xr_growth <- japan_data_pre$xr_growth
japan_export_growth <- japan_data_pre$export_growth

# List of valid countries excluding Japan, the United States, the United Kingdom, France, and Germany
valid_countries <- unique(clean_data$country)
valid_countries <- valid_countries[!(valid_countries %in% c("Japan", "United States", "United Kingdom", "France", "Germany"))]

# Create a tibble to store MSE results for each country
mse_results <- tibble(
  country_id = integer(),
  country_name = character(),
  mse_rgdpo_growth = double(),
  mse_xr_growth = double(),
  mse_export_growth = double()
)

# Loop through each valid country using the assigned ID and calculate MSE
for (i in 1:length(valid_countries)) {
  # Extract country name and corresponding ID
  country_name <- valid_countries[i]
  
  # Filter the data for the current country during the pre-treatment period (1970-1985)
  country_data_pre <- clean_data %>%
    filter(country == country_name, year >= 1970 & year <= 1985)
  
  # Extract the growth rate values for the current country
  country_rgdpo_growth <- country_data_pre$rgdpo_growth
  country_xr_growth <- country_data_pre$xr_growth
  country_export_growth <- country_data_pre$export_growth
  
  # Calculate MSE for Real GDP Growth Rate between Japan and the current country
  mse_rgdpo_growth <- mean((japan_rgdpo_growth - country_rgdpo_growth)^2, na.rm = TRUE)
  
  # Calculate MSE for Exchange Rate Growth between Japan and the current country
  mse_xr_growth <- mean((japan_xr_growth - country_xr_growth)^2, na.rm = TRUE)
  
  # Calculate MSE for Export Growth Rate between Japan and the current country
  mse_export_growth <- mean((japan_export_growth - country_export_growth)^2, na.rm = TRUE)
  
  # Only add the country to the tibble if all MSE values are <= 1
  if (mse_rgdpo_growth <= 1 && mse_xr_growth <= 1 && mse_export_growth <= 1) {
    mse_results <- mse_results %>%
      add_row(
        country_id = i,
        country_name = country_name,
        mse_rgdpo_growth = mse_rgdpo_growth,
        mse_xr_growth = mse_xr_growth,
        mse_export_growth = mse_export_growth
      )
  }
}

# Print the filtered MSE results tibble
print(mse_results)

```

```{r}
# Load necessary libraries
library(dplyr)
library(tibble)

# Filter data for the treatment group (Japan) and the control group (other countries)
treatment_group <- clean_data %>%
  filter(country == "Japan", year >= 1970 & year <= 1985)

control_group <- clean_data %>%
  filter(country != "Japan", year >= 1970 & year <= 1985)

# Step 1: Identify and Remove Outliers for Exchange Rate Growth in Control Group
# Calculate IQR to identify outliers in Exchange Rate Growth
iqr_xr_growth <- IQR(control_group$xr_growth, na.rm = TRUE)
q1 <- quantile(control_group$xr_growth, 0.25, na.rm = TRUE)
q3 <- quantile(control_group$xr_growth, 0.75, na.rm = TRUE)

# Define the upper and lower bounds
lower_bound <- q1 - 1.5 * iqr_xr_growth
upper_bound <- q3 + 1.5 * iqr_xr_growth

# Filter out outliers in Exchange Rate Growth
control_group_filtered <- control_group %>%
  filter(xr_growth >= lower_bound & xr_growth <= upper_bound)

# Step 2: Calculate Descriptive Statistics for Treatment Group
treatment_stats <- treatment_group %>%
  summarise(
    mean_rgdpo_growth = mean(rgdpo_growth, na.rm = TRUE),
    sd_rgdpo_growth = sd(rgdpo_growth, na.rm = TRUE),
    mean_xr_growth = mean(xr_growth, na.rm = TRUE),
    sd_xr_growth = sd(xr_growth, na.rm = TRUE),
    mean_export_growth = mean(export_growth, na.rm = TRUE),
    sd_export_growth = sd(export_growth, na.rm = TRUE)
  )

# Step 3: Calculate Descriptive Statistics for Control Group after Removing Outliers
control_stats_filtered <- control_group_filtered %>%
  summarise(
    mean_rgdpo_growth = mean(rgdpo_growth, na.rm = TRUE),
    sd_rgdpo_growth = sd(rgdpo_growth, na.rm = TRUE),
    mean_xr_growth = mean(xr_growth, na.rm = TRUE),
    sd_xr_growth = sd(xr_growth, na.rm = TRUE),
    mean_export_growth = mean(export_growth, na.rm = TRUE),
    sd_export_growth = sd(export_growth, na.rm = TRUE)
  )

# Step 4: Combine Treatment and Control Group Statistics into a Single Table
descriptive_stats <- tibble(
  variable = c("Real GDP Growth", "Exchange Rate Growth", "Export Growth"),
  treatment_mean = c(treatment_stats$mean_rgdpo_growth, treatment_stats$mean_xr_growth, treatment_stats$mean_export_growth),
  treatment_sd = c(treatment_stats$sd_rgdpo_growth, treatment_stats$sd_xr_growth, treatment_stats$sd_export_growth),
  control_mean = c(control_stats_filtered$mean_rgdpo_growth, control_stats_filtered$mean_xr_growth, control_stats_filtered$mean_export_growth),
  control_sd = c(control_stats_filtered$sd_rgdpo_growth, control_stats_filtered$sd_xr_growth, control_stats_filtered$sd_export_growth)
)

# Print the Descriptive Statistics Table
print(descriptive_stats)

```


```{r}
# 確保清理過的資料集 clean_data 已經存在
# 使用 dplyr 按照 country 和 year 排序，列出所有資料

library(dplyr)

# 假設 clean_data 已清理
clean_data_sorted <- clean_data %>%
  arrange(country, year)

# 列出所有國家的資料
print(clean_data_sorted)

```
```{r}
# 提取日本的 rgdpo_growth 數據
japan_rgdpo_growth <- clean_data_sorted %>%
  filter(country == "Japan", year >= 1970 & year <= 1985) %>%
  select(year, rgdpo_growth)

# 查看處理組數據
print(japan_rgdpo_growth)

```
```{r}
# 處理組的共變量（1970–1985 年）
treatment_unit_covariates <- as.matrix(japan_rgdpo_growth$rgdpo_growth[1:(1985 - 1970 + 1)])

# 提取處理組結果變數（日本在 1986-1995 年的 rgdpo_growth）
treatment_unit_outcome <- clean_data_sorted %>%
  filter(country == "Japan", year >= 1986 & year <= 1995) %>%
  pull(rgdpo_growth) %>%
  as.matrix()
```


```{r}
library(tidyr)

# 假設 mse_result 已包含所需國家的名稱
# 提取 mse_result 中的國家
selected_countries <- unique(mse_results$country_name)

# 使用 selected_countries 篩選 clean_data
filtered_clean_data <- clean_data_sorted %>%
  filter(country %in% selected_countries)

# 控制組結果變量矩陣（1986-1995）
control_unit_outcomes <- filtered_clean_data %>%
  filter(year >= 1986 & year <= 1995) %>% # 篩選年份範圍
  select(country, year, rgdpo_growth, xr_growth, export_growth) %>% # 保留需要的欄位
  pivot_wider(names_from = country, values_from = c(rgdpo_growth, xr_growth, export_growth)) %>% # 展開國家作為列
  column_to_rownames(var = "year") %>% # 將年份設為行名
  as.matrix() # 轉換為矩陣



# 使用 pivot_wider 轉換數據格式
control_unit_outcomes <- filtered_clean_data %>%
  filter(year >= 1986 & year <= 1995) %>% # 篩選年份範圍
  select(country, year, rgdpo_growth) %>% # 保留需要的欄位
  pivot_wider(names_from = country, values_from = rgdpo_growth) %>% # 展開國家作為列
  column_to_rownames(var = "year") %>% # 將年份設為行名
  as.matrix() # 轉換為矩陣


```



```{r}
# 從 clean_data 提取日本的資料
japan_data <- clean_data_sorted %>%
  filter(country == "Japan")

# 將日本的資料加入 filtered_clean_data
filtered_clean_data_combined <- bind_rows(filtered_clean_data, japan_data)

print(unique(filtered_clean_data_combined$country))
```
```{r}
# 清理數據框
cleaned_data <- filtered_clean_data_combined %>%
  filter(year >= 1970 & year <= 1995) %>% # 篩選年份範圍
  select(country, year, rgdpo_growth, xr_growth, export_growth) # 保留主要欄位

head(cleaned_data)
```
```{r}
library(dplyr)

# 為每個國家分配唯一的編號
cleaned_data <- cleaned_data %>%
  mutate(country_id = dense_rank(country)) # 按國家名稱排序並分配唯一編號

# 提取國家與編號對應表
country_mapping <- cleaned_data %>%
  select(country, country_id) %>%
  distinct() %>%
  arrange(country_id)

# 查看對應關係
print(country_mapping)


```

```{r}
cleaned_data
```

```{r}
cleaned_data <- cleaned_data %>%
  mutate(
    country_id = as.numeric(country_id),
    year = as.numeric(year),
    rgdpo_growth = as.numeric(rgdpo_growth),
    xr_growth = as.numeric(xr_growth),
    export_growth = as.numeric(export_growth)
  )

```


## rgdpo growth
```{r}
library(tidyr)

# 將數據轉為寬格式（以 rgdpo_growth 為例）
wide_data <- cleaned_data %>%
  select(country_id, year, rgdpo_growth) %>%
  pivot_wider(names_from = country_id, values_from = rgdpo_growth)

print(wide_data)

```




```{r}
library(tidyr)
library(dplyr)

# 將寬格式轉換回長格式
long_data <- wide_data %>%
  pivot_longer(
    cols = -year,               # 除年份列外的所有列
    names_to = "country_id",    # 將列名轉換為 country_id
    values_to = "rgdpo_growth"  # 將數值存儲在 rgdpo_growth
  )

# 確保數據類型正確
long_data <- long_data %>%
  mutate(
    country_id = as.numeric(country_id),  # 確保 country_id 為數字
    year = as.numeric(year),             # 確保 year 為數字
    rgdpo_growth = as.numeric(rgdpo_growth) # 確保 rgdpo_growth 為數字
  )

```

```{r}
# 檢查數據類型
str(long_data)

# 強制將 country_id 轉為數字
long_data <- long_data %>%
  mutate(country_id = as.numeric(country_id))

long_data <- as.data.frame(long_data)
```
```{r}
library(Synth)
dataprep_out <- dataprep(
  foo = long_data,                        # 數據框
  predictors = c("rgdpo_growth"),         # 共變量
  predictors.op = "mean",                 # 匹配方式
  dependent = "rgdpo_growth",             # 結果變量
  unit.variable = "country_id",           # 單位標識
  time.variable = "year",                 # 時間標識
  special.predictors = list(
    list("rgdpo_growth", 1975, "mean"),
    list("rgdpo_growth", 1980, "mean"),
    list("rgdpo_growth", 1985, "mean")
  ),
  treatment.identifier = 54,              # 處理組
  controls.identifier = setdiff(1:53, c(2,39)),# 控制組
  time.predictors.prior = c(1970:1985),   # 共變量計算期間
  time.optimize.ssr = c(1970:1985),       # 權重優化期間
  time.plot = c(1970:1995)                # 繪圖期間
)
```


```{r}
# 使用 synth 函數
synth_out <- synth(dataprep_out)

# 查看合成控制組的權重
print(synth_out$solution.w)

# 查看共變量的權重
print(synth_out$solution.v)

```
```{r}
path.plot(
  synth.res = synth_out,
  dataprep.res = dataprep_out,
  Main = "Actual vs Synthetic Control: Real GDP Growth",
  Ylab = "Real GDP Growth",
  Xlab = "Year"
)

```
```{r}
gaps.plot(
  synth.res = synth_out,
  dataprep.res = dataprep_out,
  Main = "Gap Between Treated and Synthetic Control",
  Ylab = "Gap (Actual - Synthetic)",
  Xlab = "Year"
)

```
```{r}
synth_tables <- synth.tab(
  dataprep.res = dataprep_out,
  synth.res = synth_out
)

# 打印總結表
print(synth_tables)

```

## export growth
```{r}
library(tidyr)

# 將數據轉為寬格式（以 export_growth 為例）
wide_data_1 <- cleaned_data %>%
  select(country_id, year, export_growth) %>%
  pivot_wider(names_from = country_id, values_from = export_growth)

print(wide_data_1)
```

```{r}
library(tidyr)
library(dplyr)

# 將寬格式轉換回長格式
long_data_1 <- wide_data_1 %>%
  pivot_longer(
    cols = -year,               # 除年份列外的所有列
    names_to = "country_id",    # 將列名轉換為 country_id
    values_to = "export_growth"  # 將數值存儲在 export_growth
  )

# 確保數據類型正確
long_data_1 <- long_data_1 %>%
  mutate(
    country_id = as.numeric(country_id),  # 確保 country_id 為數字
    year = as.numeric(year),             # 確保 year 為數字
    export_growth = as.numeric(export_growth) # 確保 export_growth 為數字
  )
```

```{r}
# 強制將 country_id 轉為數字
long_data_1 <- long_data_1 %>%
  mutate(country_id = as.numeric(country_id))

long_data_1 <- as.data.frame(long_data_1)

```

```{r}
dataprep_out_1 <- dataprep(
  foo = long_data_1,                        # 數據框
  predictors = c("export_growth"),         # 共變量
  predictors.op = "mean",                 # 匹配方式
  dependent = "export_growth",             # 結果變量
  unit.variable = "country_id",           # 單位標識
  time.variable = "year",                 # 時間標識
  special.predictors = list(
    list("export_growth", 1975, "mean"),
    list("export_growth", 1980, "mean"),
    list("export_growth", 1985, "mean")
  ),
  treatment.identifier = 54,              # 處理組
  controls.identifier = setdiff(1:53, c(2,39)),# 控制組
  time.predictors.prior = c(1970:1985),   # 共變量計算期間
  time.optimize.ssr = c(1970:1985),       # 權重優化期間
  time.plot = c(1970:1995)                # 繪圖期間
)
```

```{r}
# 使用 synth 函數
synth_out_1 <- synth(dataprep_out_1)

# 查看合成控制組的權重
print(synth_out_1$solution.w)

# 查看共變量的權重
print(synth_out_1$solution.v)
```

```{r}
path.plot(
  synth.res = synth_out_1,
  dataprep.res = dataprep_out_1,
  Main = "Actual vs Synthetic Control: Export Growth",
  Ylab = "Export Growth",
  Xlab = "Year"
)
```

```{r}
gaps.plot(
  synth.res = synth_out_1,
  dataprep.res = dataprep_out_1,
  Main = "Gap Between Treated and Synthetic Control",
  Ylab = "Gap (Actual - Synthetic)",
  Xlab = "Year"
)
```

```{r}
synth_tables_1 <- synth.tab(
  dataprep.res = dataprep_out_1,
  synth.res = synth_out_1
)

# 打印總結表
print(synth_tables_1)
```

## xr_growth
```{r}
library(tidyr)

# 將數據轉為寬格式（以 xr_growth 為例）
wide_data_2 <- cleaned_data %>%
  select(country_id, year, xr_growth) %>%
  pivot_wider(names_from = country_id, values_from = xr_growth)

print(wide_data_2)
```

```{r}
library(tidyr)
library(dplyr)

# 將寬格式轉換回長格式
long_data_2 <- wide_data_2 %>%
  pivot_longer(
    cols = -year,               # 除年份列外的所有列
    names_to = "country_id",    # 將列名轉換為 country_id
    values_to = "xr_growth"  # 將數值存儲在 xr_growth
  )

# 確保數據類型正確
long_data_2 <- long_data_2 %>%
  mutate(
    country_id = as.numeric(country_id),  # 確保 country_id 為數字
    year = as.numeric(year),             # 確保 year 為數字
    xr_growth = as.numeric(xr_growth) # 確保 xr_growth 為數字
  )
```

```{r}
# 強制將 country_id 轉為數字
long_data_2 <- long_data_2 %>%
  mutate(country_id = as.numeric(country_id))

long_data_2 <- as.data.frame(long_data_2)

```





```{r}
dataprep_out_2 <- dataprep(
  foo = long_data_2,                        # 數據框
  predictors = c("xr_growth"),         # 共變量
  predictors.op = "mean",                 # 匹配方式
  dependent = "xr_growth",             # 結果變量
  unit.variable = "country_id",           # 單位標識
  time.variable = "year",                 # 時間標識
  special.predictors = list(
    list("xr_growth", 1975, "mean"),
    list("xr_growth", 1980, "mean"),
    list("xr_growth", 1985, "mean")
  ),
  treatment.identifier = 54,              # 處理組
  controls.identifier = setdiff(1:53, c(2,39)),# 控制組
  time.predictors.prior = c(1970:1985),   # 共變量計算期間
  time.optimize.ssr = c(1970:1985),       # 權重優化期間
  time.plot = c(1970:1995)                # 繪圖期間
)
```

```{r}
# 使用 synth 函數
synth_out_2 <- synth(dataprep_out_2)

# 查看合成控制組的權重
print(synth_out_2$solution.w)

# 查看共變量的權重
print(synth_out_2$solution.v)
```

```{r}
path.plot(
  synth.res = synth_out_2,
  dataprep.res = dataprep_out_2,
  Main = "Actual vs Synthetic Control: xr Growth",
  Ylab = "xr Growth",
  Xlab = "Year"
)
```

```{r}
gaps.plot(
  synth.res = synth_out_2,
  dataprep.res = dataprep_out_2,
  Main = "Gap Between Treated and Synthetic Control",
  Ylab = "Gap (Actual - Synthetic)",
  Xlab = "Year"
)
```
```{r}
synth_tables_2 <- synth.tab(
  dataprep.res = dataprep_out_2,
  synth.res = synth_out_2
)

# 打印總結表
print(synth_tables_2)
```

#Placebo test (rgdpo)
```{r}
# 加載必要的包
library(Synth)
library(dplyr)

# 創建一個空的結果列表來存儲每次的合成控制結果
placebo_results <- list()

# 獲取所有控制組的國家 ID
control_ids <- setdiff(1:53, c(2,39,54)) # 排除處理組 (54 是日本)

# 計算處理前的 RMSPE
rmspe_pre_original <- sqrt(mean(original_gaps[1:(1985 - 1970 + 1)]^2, na.rm = TRUE)) # 計算處理組的 RMSPE
rmspe_pre <- sapply(placebo_gaps, function(gap) sqrt(mean(gap[1:(1985 - 1970 + 1)]^2, na.rm = TRUE))) # 計算控制組的 RMSPE

# Placebo 測試：對每個控制組國家進行一次
for (placebo_id in control_ids) {
  
  # 設置處理組為當前的 placebo_id
  treatment_identifier <- placebo_id
  
  # 設置控制組為除了 placebo_id 和 54 之外的國家
  controls_identifier <- setdiff(control_ids, placebo_id)
  
  # 準備數據
  dataprep_out <- dataprep(
    foo = long_data,                        
    predictors = c("rgdpo_growth"),         
    predictors.op = "mean",                 
    dependent = "rgdpo_growth",             
    unit.variable = "country_id",           
    time.variable = "year",                 
    special.predictors = list(
      list("rgdpo_growth", 1975, "mean"),
      list("rgdpo_growth", 1980, "mean"),
      list("rgdpo_growth", 1985, "mean")
    ),
    treatment.identifier = treatment_identifier, 
    controls.identifier = controls_identifier,  
    time.predictors.prior = c(1970:1985),       
    time.optimize.ssr = c(1970:1985),           
    time.plot = c(1970:1995)                    
  )
  
  # 構建合成控制
  synth_out <- synth(dataprep_out)
  
  # 存儲結果
  placebo_results[[as.character(placebo_id)]] <- list(
    synth_out = synth_out,
    dataprep_out = dataprep_out
  )
} 

# 原始合成控制結果的 GAP
original_gaps <- dataprep_out$Y1plot - (dataprep_out$Y0plot %*% synth_out$solution.w)

# 提取每次 Placebo 測試的 GAP
placebo_gaps <- lapply(placebo_results, function(result) {
  result$dataprep_out$Y1plot - (result$dataprep_out$Y0plot %*% result$synth_out$solution.w)
})

# 繪圖比較 GAP
plot(1970:1995, original_gaps, type = "l", col = "red", lwd = 2,
     main = "Placebo Test for Synthetic Control",
     xlab = "Year", ylab = "Gap (Actual - Synthetic)")
for (gaps in placebo_gaps) {
  lines(1970:1995, gaps, col = "gray", lty = 2)
}
legend("topright", legend = c("Original (Japan)", "Placebo Tests"),
       col = c("red", "gray"), lty = c(1, 2), lwd = c(2, 1))

# 計算原始 GAP 的均值和標準差
original_mean <- mean(original_gaps) 
original_sd <- sd(original_gaps) 

# 提取處理後 (1986-1995) 的原始 GAP
post_treatment_gaps <- original_gaps[1986:1995 - 1970 + 1]

# 提取處理後 (1986-1995) 的 Placebo 測試 GAP
post_placebo_gaps <- lapply(placebo_gaps, function(gap) {
  gap[1986:1995 - 1970 + 1]
})

# 計算原始 GAP 和 Placebo 測試的均值和標準差 (1986-1995)
mean_original_post <- mean(post_treatment_gaps, na.rm = TRUE)
sd_original_post <- sd(post_treatment_gaps, na.rm = TRUE)

placebo_means_post <- sapply(post_placebo_gaps, mean, na.rm = TRUE)
placebo_sds_post <- sapply(post_placebo_gaps, sd, na.rm = TRUE)

# Basic p-value 計算
basic_p_values <- sapply(1:length(post_treatment_gaps), function(t) {
  sum(sapply(post_placebo_gaps, function(gap) {
    gap[t] >= post_treatment_gaps[t]
  })) / length(post_placebo_gaps)
})

# 繪製 Basic p-value 圖表
plot(1986:1995, basic_p_values, type = "b", col = "blue",
     main = "Basic p-value for Placebo Test",
     xlab = "Year", ylab = "Basic p-value")
abline(h = 0.05, col = "red", lty = 2)  # 顯著水平線

# 計算每個 Placebo 測試 GAP 的均值和標準差
placebo_means <- sapply(placebo_gaps, mean)
placebo_sds <- sapply(placebo_gaps, sd)

# 比較原始結果與 Placebo 測試
comparison <- data.frame(
  Placebo_ID = names(placebo_gaps),
  Placebo_Mean = placebo_means,
  Placebo_SD = placebo_sds
)

print(comparison)

# 計算標準化 p-value
standardized_p_values <- sapply(1:length(post_treatment_gaps), function(t) {
  sum(sapply(post_placebo_gaps, function(gap) {
    if (is.numeric(gap)) {
      (gap[t] / rmspe_pre_original) >= 
      (post_treatment_gaps[t] / rmspe_pre_original)
    } else {
      FALSE  # 確保處理非數值情況
    }
  })) / length(post_placebo_gaps)
})

# 繪製 Standardized p-value 圖表
plot(1986:1995, standardized_p_values, type = "b", col = "blue",
     main = "Standardized p-value for Placebo Test",
     xlab = "Year", ylab = "Standardized p-value")
abline(h = 0.05, col = "red", lty = 2)  # 顯著水平線

# 計算處理後 RMSPE
rmspe_post <- sapply(post_placebo_gaps, function(gap) {
  sqrt(mean(gap^2, na.rm = TRUE))
})
rmspe_post_original <- sqrt(mean(post_treatment_gaps^2, na.rm = TRUE))

# RMSPE Ratio 計算
rmspe_ratios <- rmspe_post / rmspe_pre
rmspe_ratio_original <- rmspe_post_original / rmspe_pre_original

# RMSPE Ratio Test p-value 計算
rmspe_ratio_p_value <- sum(rmspe_ratios >= rmspe_ratio_original) / length(rmspe_ratios)

# 輸出結果
cat("RMSPE Ratio Test p-value:", rmspe_ratio_p_value, "\n")

```
## Placebo test(export)
```{r}
# 加載必要的包
library(Synth)
library(dplyr)

# 創建一個空的結果列表來存儲每次的合成控制結果
placebo_results_export <- list()

# 確保控制組和處理組 ID 有效
control_ids <- setdiff(1:53, c(2,39,54))  # 排除處理組 (54 是日本)

# Placebo 測試：對每個控制組國家進行一次
for (placebo_id in control_ids) {

  # 檢查 placebo_id 是否有效
  if (!(placebo_id %in% long_data_1$country_id)) {
    next  # 跳過無效的 placebo_id
  }

  treatment_identifier <- placebo_id
  controls_identifier <- setdiff(control_ids, placebo_id)

  # 準備數據
  dataprep_out_export <- dataprep(
    foo = long_data_1,
    predictors = c("export_growth"),
    predictors.op = "mean",
    dependent = "export_growth",
    unit.variable = "country_id",
    time.variable = "year",
    special.predictors = list(
      list("export_growth", 1975, "mean"),
      list("export_growth", 1980, "mean"),
      list("export_growth", 1985, "mean")
    ),
    treatment.identifier = treatment_identifier, 
    controls.identifier = controls_identifier,
    time.predictors.prior = c(1970:1985),
    time.optimize.ssr = c(1970:1985),
    time.plot = c(1970:1995)
  )

  # 檢查是否成功生成數據
  if (is.null(dataprep_out_export$Y1plot)) {
    next  # 跳過無效的數據準備
  }

  # 構建合成控制
  synth_out_export <- synth(dataprep_out_export)

  # 存儲結果
  placebo_results_export[[as.character(placebo_id)]] <- list(
    synth_out = synth_out_export,
    dataprep_out = dataprep_out_export
  )
}

# 原始合成控制結果的 GAP (export_growth)
original_gaps_export <- dataprep_out_export$Y1plot - (dataprep_out_export$Y0plot %*% synth_out_export$solution.w)

# 提取每次 Placebo 測試的 GAP (export_growth)
placebo_gaps_export <- lapply(placebo_results_export, function(result) {
  result$dataprep_out$Y1plot - (result$dataprep_out$Y0plot %*% result$synth_out$solution.w)
})

# 繪圖比較 GAP (export_growth)
plot(1970:1995, original_gaps_export, type = "l", col = "blue", lwd = 2,
     main = "Placebo Test for Synthetic Control (export_growth)",
     xlab = "Year", ylab = "Gap (Actual - Synthetic)")
for (gaps in placebo_gaps_export) {
  lines(1970:1995, gaps, col = "gray", lty = 2)
}
legend("topright", legend = c("Original (Japan)", "Placebo Tests"),
       col = c("blue", "gray"), lty = c(1, 2), lwd = c(2, 1))

# 計算原始 GAP 的均值和標準差 (export_growth)
original_mean_export <- mean(original_gaps_export)
original_sd_export <- sd(original_gaps_export)

# 計算 Placebo 測試 GAP 的均值和標準差 (export_growth)
placebo_means_export <- sapply(placebo_gaps_export, mean)
placebo_sds_export <- sapply(placebo_gaps_export, sd)

# 比較原始結果與 Placebo 測試
comparison_export <- data.frame(
  Placebo_ID = names(placebo_gaps_export),
  Placebo_Mean = placebo_means_export,
  Placebo_SD = placebo_sds_export
)

print(comparison_export)

# 提取處理後 (1986-1995) 的原始 GAP (export_growth)
post_treatment_gaps_export <- original_gaps_export[1986:1995 - 1970 + 1]

# 提取處理後 (1986-1995) 的 Placebo 測試 GAP (export_growth)
post_placebo_gaps_export <- lapply(placebo_gaps_export, function(gap) {
  gap[1986:1995 - 1970 + 1]
})

# 計算原始 GAP 的均值和標準差 (1986-1995, export_growth)
mean_original_post_export <- mean(post_treatment_gaps_export, na.rm = TRUE)
sd_original_post_export <- sd(post_treatment_gaps_export, na.rm = TRUE)

# 計算每個 Placebo 測試 GAP 的均值和標準差 (1986-1995, export_growth)
placebo_means_post_export <- sapply(post_placebo_gaps_export, mean, na.rm = TRUE)
placebo_sds_post_export <- sapply(post_placebo_gaps_export, sd, na.rm = TRUE)

# 計算 Basic p-value
basic_p_values_export <- sapply(1:length(post_treatment_gaps_export), function(t) {
  sum(sapply(post_placebo_gaps_export, function(gap) {
    gap[t] >= post_treatment_gaps_export[t]
  })) / length(post_placebo_gaps_export)
})

# 繪製 Basic p-value 圖表
plot(1986:1995, basic_p_values_export, type = "b", col = "blue",
     main = "Basic p-value for Placebo Test (export_growth)",
     xlab = "Year", ylab = "Basic p-value")
abline(h = 0.05, col = "red", lty = 2)  # 顯著水平線

# 計算 RMSPE (Root Mean Squared Prediction Error) for Pre-Treatment
calc_rmspe <- function(gaps, pre_treatment_period) {
  sqrt(mean(gaps[pre_treatment_period]^2, na.rm = TRUE))
}

# 定義前處理期間 (1970-1985)
pre_treatment_period <- 1970:1985 - 1970 + 1

# 計算處理組的 RMSPE
rmspe_original_pre_export <- calc_rmspe(original_gaps_export, pre_treatment_period)

# 計算 Placebo 測試的 RMSPE
rmspe_placebo_pre_export <- sapply(placebo_gaps_export, calc_rmspe, pre_treatment_period = pre_treatment_period)

# 計算標準化 GAP 值 (處理組)
standardized_original_gaps <- original_gaps_export / rmspe_original_pre_export

# 計算標準化 GAP 值 (Placebo 測試)
standardized_placebo_gaps <- lapply(placebo_gaps_export, function(gaps) {
  gaps / calc_rmspe(gaps, pre_treatment_period)
})

# 計算每年的 Standardized p-value
standardized_p_values_export <- sapply(1:length(post_treatment_gaps_export), function(t) {
  mean(sapply(standardized_placebo_gaps, function(gaps) {
    gaps[t + length(pre_treatment_period)] >= standardized_original_gaps[t + length(pre_treatment_period)]
  }), na.rm = TRUE)
})

# 繪製 Standardized p-value 圖表
plot(1986:1995, standardized_p_values_export, type = "b", col = "blue",
     main = "Standardized p-value for Placebo Test (export_growth)",
     xlab = "Year", ylab = "Standardized p-value")
abline(h = 0.05, col = "red", lty = 2)  # 顯著水平線

# 計算處理後 RMSPE (post-treatment RMSPE)
rmspe_post_export <- sapply(placebo_gaps_export, function(gap) {
  if (is.numeric(gap)) {
    sqrt(mean(gap[(1986 - 1970 + 1):(1995 - 1970 + 1)]^2, na.rm = TRUE))
  } else {
    NA
  }
})
rmspe_post_original_export <- sqrt(mean(original_gaps_export[(1986 - 1970 + 1):(1995 - 1970 + 1)]^2, na.rm = TRUE))

# RMSPE Ratio 計算
rmspe_ratios <- sapply(placebo_gaps_export, function(gap) {
  if (is.numeric(gap)) {
    rmspe_post <- sqrt(mean(gap[(1986 - 1970 + 1):(1995 - 1970 + 1)]^2, na.rm = TRUE))
    rmspe_pre <- sqrt(mean(gap[1:(1985 - 1970 + 1)]^2, na.rm = TRUE))
    if (!is.na(rmspe_post) && !is.na(rmspe_pre) && rmspe_pre != 0) {
      return(rmspe_post / rmspe_pre)
    } else {
      return(NA)
    }
  } else {
    return(NA)
  }
})

# 計算原始的 RMSPE 比例
rmspe_ratio_original <- rmspe_post_original_export / rmspe_pre_original_export

# 計算 p-value
rmspe_ratio_p_value <- sum(rmspe_ratios >= rmspe_ratio_original, na.rm = TRUE) / length(rmspe_ratios)

# 輸出結果
cat("RMSPE Ratio for Original:", rmspe_ratio_original, "\n")
cat("P-value for RMSPE Ratio Test:", rmspe_ratio_p_value, "\n")

```
## Placebo test(xr)
```{r}
# 加載必要的包
library(Synth)
library(dplyr)

# 創建一個空的結果列表來存儲每次的合成控制結果
placebo_results_xr <- list()

# 獲取所有控制組的國家 ID (假設國家編號為 1 到 53，其中 54 是日本)
control_ids <- setdiff(1:53, c(2,39,54)) # 排除處理組 (日本)

# Placebo 測試：對每個控制組國家進行一次
for (placebo_id in control_ids) {
  
  # 設置處理組為當前的 placebo_id
  treatment_identifier <- placebo_id
  
  # 設置控制組為除了 placebo_id 和 54 之外的國家
  controls_identifier <- setdiff(control_ids, placebo_id)
  
  # 準備數據
  dataprep_out_xr <- dataprep(
    foo = long_data_2,                        
    predictors = c("xr_growth"),            # 使用 xr_growth 作為預測變數
    predictors.op = "mean",                 
    dependent = "xr_growth",                # 依賴變數為 xr_growth
    unit.variable = "country_id",           
    time.variable = "year",                 
    special.predictors = list(
      list("xr_growth", 1975, "mean"),
      list("xr_growth", 1980, "mean"),
      list("xr_growth", 1985, "mean")
    ),
    treatment.identifier = treatment_identifier, 
    controls.identifier = controls_identifier,  
    time.predictors.prior = c(1970:1985),       
    time.optimize.ssr = c(1970:1985),           
    time.plot = c(1970:1995)                    
  )
  
  # 構建合成控制
  synth_out_xr <- synth(dataprep_out_xr)
  
  # 存儲結果
  placebo_results_xr[[as.character(placebo_id)]] <- list(
    synth_out = synth_out_xr,
    dataprep_out = dataprep_out_xr
  )
}

# 原始合成控制結果的 GAP (xr_growth)
original_gaps_xr <- dataprep_out_xr$Y1plot - (dataprep_out_xr$Y0plot %*% synth_out_xr$solution.w)

# 提取每次 Placebo 測試的 GAP (xr_growth)
placebo_gaps_xr <- lapply(placebo_results_xr, function(result) {
  result$dataprep_out$Y1plot - (result$dataprep_out$Y0plot %*% result$synth_out$solution.w)
})

```

```{r}
# 繪圖比較 GAP (xr_growth)
plot(1970:1995, original_gaps_xr, type = "l", col = "darkgreen", lwd = 2,
     main = "Placebo Test for Synthetic Control (xr_growth)",
     xlab = "Year", ylab = "Gap (Actual - Synthetic)")
for (gaps in placebo_gaps_xr) {
  lines(1970:1995, gaps, col = "gray", lty = 2)
}
legend("topright", legend = c("Original (Japan)", "Placebo Tests"),
       col = c("darkgreen", "gray"), lty = c(1, 2), lwd = c(2, 1))

```

```{r}
# 計算原始 GAP 的均值和標準差
original_mean_xr <- mean(original_gaps_xr)
original_sd_xr <- sd(original_gaps_xr)

# 計算 Placebo 測試 GAP 的均值和標準差
placebo_means_xr <- sapply(placebo_gaps_xr, mean)
placebo_sds_xr <- sapply(placebo_gaps_xr, sd)

# 比較原始結果與 Placebo 測試
comparison_xr <- data.frame(
  Placebo_ID = names(placebo_gaps_xr),
  Placebo_Mean = placebo_means_xr,
  Placebo_SD = placebo_sds_xr
)

print(comparison_xr)

```

```{r}
# 提取處理後 (1986-1995) 的原始 GAP
post_treatment_gaps_xr <- original_gaps_xr[1986:1995 - 1970 + 1]

# 提取處理後 (1986-1995) 的 Placebo 測試 GAP
post_placebo_gaps_xr <- lapply(placebo_gaps_xr, function(gap) {
  gap[1986:1995 - 1970 + 1]
})

# 計算原始 GAP 的均值和標準差 (1986-1995)
mean_original_post_xr <- mean(post_treatment_gaps_xr, na.rm = TRUE)
sd_original_post_xr <- sd(post_treatment_gaps_xr, na.rm = TRUE)

# 計算每個 Placebo 測試 GAP 的均值和標準差 (1986-1995)
placebo_means_post_xr <- sapply(post_placebo_gaps_xr, mean, na.rm = TRUE)
placebo_sds_post_xr <- sapply(post_placebo_gaps_xr, sd, na.rm = TRUE)

```

```{r}
# 提取處理後 (1986-1995) 的原始 GAP
post_treatment_gaps_xr <- original_gaps_xr[1986:1995 - 1970 + 1]

# 提取處理後 (1986-1995) 的 Placebo 測試 GAP
post_placebo_gaps_xr <- lapply(placebo_gaps_xr, function(gap) {
  gap[1986:1995 - 1970 + 1]
})

# 計算 Basic p-value
basic_p_values_xr <- sapply(1:length(post_treatment_gaps_xr), function(t) {
  # 當前時間點的原始 GAP
  original_gap <- post_treatment_gaps_xr[t]
  
  # 計算有多少 placebo GAP 大於等於原始 GAP
  sum(sapply(post_placebo_gaps_xr, function(gap) {
    gap[t] >= original_gap
  })) / length(post_placebo_gaps_xr)  # 除以 placebo 測試數量
})

# 繪製 Basic p-value 圖表
plot(1986:1995, basic_p_values_xr, type = "b", col = "blue",
     main = "Basic p-value for Placebo Test (xr_growth)",
     xlab = "Year", ylab = "Basic p-value")
abline(h = 0.05, col = "red", lty = 2)  # 顯著水平線

```

```{r}
# 計算前處理期間的 RMSPE
calculate_rmspe <- function(actual, synthetic, pre_period) {
  sqrt(mean((actual[pre_period] - synthetic[pre_period])^2))
}

# 提取前處理期間 (1970-1985)
pre_treatment_period <- 1970:1985 - 1970 + 1

# 原始組的 RMSPE
original_rmspe_xr <- calculate_rmspe(
  actual = dataprep_out_xr$Y1plot,
  synthetic = dataprep_out_xr$Y0plot %*% synth_out_xr$solution.w,
  pre_period = pre_treatment_period
)

# 每個 Placebo 測試的 RMSPE
placebo_rmspe_xr <- sapply(placebo_results_xr, function(result) {
  calculate_rmspe(
    actual = result$dataprep_out$Y1plot,
    synthetic = result$dataprep_out$Y0plot %*% result$synth_out$solution.w,
    pre_period = pre_treatment_period
  )
})
# 計算後處理期間的標準化 GAP
post_treatment_period <- 1986:1995 - 1970 + 1

standardized_gaps_original_xr <- post_treatment_gaps_xr / original_rmspe_xr
standardized_gaps_placebo_xr <- lapply(post_placebo_gaps_xr, function(gap, rmspe) {
  gap / rmspe
}, rmspe = placebo_rmspe_xr)
# 計算標準化 p-value
standardized_p_values_xr <- sapply(1:length(post_treatment_period), function(t) {
  sum(sapply(standardized_gaps_placebo_xr, function(standardized_gap) {
    standardized_gap[t] >= standardized_gaps_original_xr[t]
  })) / length(standardized_gaps_placebo_xr)
})

# 繪製標準化 p-value 圖表
plot(1986:1995, standardized_p_values_xr, type = "b", col = "blue",
     main = "Standardized p-value for Placebo Test (xr_growth)",
     xlab = "Year", ylab = "Standardized p-value")
abline(h = 0.05, col = "red", lty = 2)  # 顯著水平線

```
```{r}
# 計算處理後期間的 RMSPE
calculate_post_rmspe <- function(actual, synthetic, post_period) {
  sqrt(mean((actual[post_period] - synthetic[post_period])^2))
}

# 提取處理後期間 (1986-1995)
post_treatment_period <- 1986:1995 - 1970 + 1

# 原始組的處理後 RMSPE
post_rmspe_original_xr <- calculate_post_rmspe(
  actual = dataprep_out_xr$Y1plot,
  synthetic = dataprep_out_xr$Y0plot %*% synth_out_xr$solution.w,
  post_period = post_treatment_period
)

# 每個 Placebo 測試的處理後 RMSPE
post_rmspe_placebo_xr <- sapply(placebo_results_xr, function(result) {
  calculate_post_rmspe(
    actual = result$dataprep_out$Y1plot,
    synthetic = result$dataprep_out$Y0plot %*% result$synth_out$solution.w,
    post_period = post_treatment_period
  )
})
# 計算 RMSPE 比值 (處理後 RMSPE / 處理前 RMSPE)
rmspe_ratio_original_xr <- post_rmspe_original_xr / original_rmspe_xr

rmspe_ratios_placebo_xr <- post_rmspe_placebo_xr / placebo_rmspe_xr
# 計算 RMSPE Ratio Test 的 p-value
rmspe_ratio_p_value <- sum(rmspe_ratios_placebo_xr >= rmspe_ratio_original_xr) / length(rmspe_ratios_placebo_xr)

# 輸出結果
cat("RMSPE Ratio Test p-value:", rmspe_ratio_p_value, "\n")


```
```{r}
# 加載必要的包
library(Synth)
library(dplyr)

# 創建一個空的結果列表來存儲每次的合成控制結果
placebo_results_xr <- list()

# 獲取所有控制組的國家 ID (假設國家編號為 1 到 53，其中 54 是日本)
control_ids <- setdiff(1:53, c(2,39,54)) # 排除處理組 (日本)

# Placebo 測試：對每個控制組國家進行一次
for (placebo_id in control_ids) {
  
  # 設置處理組為當前的 placebo_id
  treatment_identifier <- placebo_id
  
  # 設置控制組為除了 placebo_id 和 54 之外的國家
  controls_identifier <- setdiff(control_ids, placebo_id)
  
  # 準備數據
  dataprep_out_xr <- dataprep(
    foo = long_data_2,                        
    predictors = c("xr_growth"),            # 使用 xr_growth 作為預測變數
    predictors.op = "mean",                 
    dependent = "xr_growth",                # 依賴變數為 xr_growth
    unit.variable = "country_id",           
    time.variable = "year",                 
    special.predictors = list(
      list("xr_growth", 1975, "mean"),
      list("xr_growth", 1980, "mean"),
      list("xr_growth", 1985, "mean")
    ),
    treatment.identifier = treatment_identifier, 
    controls.identifier = controls_identifier,  
    time.predictors.prior = c(1970:1985),       
    time.optimize.ssr = c(1970:1985),           
    time.plot = c(1970:1995)                    
  )
  
  # 構建合成控制
  synth_out_xr <- synth(dataprep_out_xr)
  
  # 存儲結果
  placebo_results_xr[[as.character(placebo_id)]] <- list(
    synth_out = synth_out_xr,
    dataprep_out = dataprep_out_xr
  )
}

# 原始合成控制結果的 GAP (xr_growth)
original_gaps_xr <- dataprep_out_xr$Y1plot - (dataprep_out_xr$Y0plot %*% synth_out_xr$solution.w)

# 提取每次 Placebo 測試的 GAP (xr_growth)
placebo_gaps_xr <- lapply(placebo_results_xr, function(result) {
  result$dataprep_out$Y1plot - (result$dataprep_out$Y0plot %*% result$synth_out$solution.w)
})

# 繪圖比較 GAP (xr_growth)
plot(1970:1995, original_gaps_xr, type = "l", col = "darkgreen", lwd = 2,
     main = "Placebo Test for Synthetic Control (xr_growth)",
     xlab = "Year", ylab = "Gap (Actual - Synthetic)")
for (gaps in placebo_gaps_xr) {
  lines(1970:1995, gaps, col = "gray", lty = 2)
}
legend("topright", legend = c("Original (Japan)", "Placebo Tests"),
       col = c("darkgreen", "gray"), lty = c(1, 2), lwd = c(2, 1))

# 計算原始 GAP 的均值和標準差
original_mean_xr <- mean(original_gaps_xr)
original_sd_xr <- sd(original_gaps_xr)

# 計算 Placebo 測試 GAP 的均值和標準差
placebo_means_xr <- sapply(placebo_gaps_xr, mean)
placebo_sds_xr <- sapply(placebo_gaps_xr, sd)

# 比較原始結果與 Placebo 測試
comparison_xr <- data.frame(
  Placebo_ID = names(placebo_gaps_xr),
  Placebo_Mean = placebo_means_xr,
  Placebo_SD = placebo_sds_xr
)

print(comparison_xr)

# 提取處理後 (1986-1995) 的原始 GAP
post_treatment_gaps_xr <- original_gaps_xr[17:26]  # 1986-1995的索引

# 提取處理後 (1986-1995) 的 Placebo 測試 GAP
post_placebo_gaps_xr <- lapply(placebo_gaps_xr, function(gap) {
  gap[17:26]  # 1986-1995的索引
})

# 計算 Basic p-value
basic_p_values_xr <- sapply(1:length(post_treatment_gaps_xr), function(t) {
  sum(sapply(post_placebo_gaps_xr, function(gap) {
    gap[t] >= post_treatment_gaps_xr[t]
  })) / length(post_placebo_gaps_xr)
})

# 繪製 Basic p-value 圖表
plot(1986:1995, basic_p_values_xr, type = "b", col = "blue",
     main = "Basic p-value for Placebo Test (xr_growth)",
     xlab = "Year", ylab = "Basic p-value")
abline(h = 0.05, col = "red", lty = 2)  # 顯著水平線

# 計算前處理期間的 RMSPE
calculate_rmspe <- function(actual, synthetic, pre_period) {
  sqrt(mean((actual[pre_period] - synthetic[pre_period])^2))
}

# 提取前處理期間 (1970-1985)
pre_treatment_period <- 1:16  # 1970-1985的索引

# 原始組的 RMSPE
original_rmspe_xr <- calculate_rmspe(
  actual = dataprep_out_xr$Y1plot,
  synthetic = dataprep_out_xr$Y0plot %*% synth_out_xr$solution.w,
  pre_period = pre_treatment_period
)

# 每個 Placebo 測試的 RMSPE
placebo_rmspe_xr <- sapply(placebo_results_xr, function(result) {
  calculate_rmspe(
    actual = result$dataprep_out$Y1plot,
    synthetic = result$dataprep_out$Y0plot %*% result$synth_out$solution.w,
    pre_period = pre_treatment_period
  )
})

# 計算後處理期間的標準化 GAP
post_treatment_period <- 17:26  # 1986-1995的索引

standardized_gaps_original_xr <- post_treatment_gaps_xr / original_rmspe_xr
standardized_gaps_placebo_xr <- lapply(post_placebo_gaps_xr, function(gap, rmspe) {
  gap / rmspe
}, rmspe = placebo_rmspe_xr)

# 計算標準化 p-value
standardized_p_values_xr <- sapply(1:length(post_treatment_period), function(t) {
  sum(sapply(standardized_gaps_placebo_xr, function(standardized_gap) {
    standardized_gap[t] >= standardized_gaps_original_xr[t]
  })) / length(standardized_gaps_placebo_xr)
})

# 繪製標準化 p-value 圖表
plot(1986:1995, standardized_p_values_xr, type = "b", col = "blue",
     main = "Standardized p-value for Placebo Test (xr_growth)",
     xlab = "Year", ylab = "Standardized p-value")
abline(h = 0.05, col = "red", lty = 2)  # 顯著水平線

# 計算處理後期間的 RMSPE
calculate_post_rmspe <- function(actual, synthetic, post_period) {
  sqrt(mean((actual[post_period] - synthetic[post_period])^2))
}

# 原始組的處理後 RMSPE
post_rmspe_original_xr <- calculate_post_rmspe(
  actual = dataprep_out_xr$Y1plot,
  synthetic = dataprep_out_xr$Y0plot %*% synth_out_xr$solution.w,
  post_period = post_treatment_period
)

# 每個 Placebo 測試的處理後 RMSPE
post_rmspe_placebo_xr <- sapply(placebo_results_xr, function(result) {
  calculate_post_rmspe(
    actual = result$dataprep_out$Y1plot,
    synthetic = result$dataprep_out$Y0plot %*% result$synth_out$solution.w,
    post_period = post_treatment_period
  )
})

# 計算 RMSPE 比值 (處理後 RMSPE / 處理前 RMSPE)
rmspe_ratio_original_xr <- post_rmspe_original_xr / original_rmspe_xr
rmspe_ratios_placebo_xr <- post_rmspe_placebo_xr / placebo_rmspe_xr

# 計算 RMSPE Ratio Test 的 p-value
rmspe_ratio_p_value <- sum(rmspe_ratios_placebo_xr >= rmspe_ratio_original_xr) / length(rmspe_ratios_placebo_xr)

# 輸出結果
cat("RMSPE Ratio Test p-value:", rmspe_ratio_p_value, "\n")

```













